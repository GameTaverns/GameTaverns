# GameTaverns Multi-Tenant Stack
# Complete self-hosted solution with PostgreSQL, Express API, and Nginx frontend
#
# Usage:
#   ./install.sh               # Interactive setup
#   docker compose up -d       # Start all services
#   docker compose logs -f     # View logs
#   docker compose down        # Stop all services

services:
  # ===================
  # PostgreSQL Database
  # ===================
  db:
    image: postgres:16-alpine
    container_name: gametaverns-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: gametaverns
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d gametaverns"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - gametaverns

  # ===================
  # Express API Server
  # ===================
  api:
    build:
      context: ../../server
      dockerfile: ../deploy/multitenant/Dockerfile.api
    container_name: gametaverns-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@db:5432/gametaverns
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      SITE_NAME: ${SITE_NAME:-GameTaverns}
      SITE_URL: ${SITE_URL:-https://gametaverns.com}
      CORS_ORIGINS: ${CORS_ORIGINS:-https://gametaverns.com,https://*.gametaverns.com}
      # Email (SMTP) - REQUIRED for email verification
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@gametaverns.com}
      # Security
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY:-}
      PII_ENCRYPTION_KEY: ${PII_ENCRYPTION_KEY:-}
      # AI (Optional - BYOK)
      AI_PROVIDER: ${AI_PROVIDER:-}
      AI_API_KEY: ${AI_API_KEY:-}
      # Discord (Optional)
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:-}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:-}
      # Platform admins (comma-separated emails)
      PLATFORM_ADMINS: ${PLATFORM_ADMINS:-}
      # Upload directory
      UPLOAD_DIR: /app/uploads
    volumes:
      - uploads:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gametaverns

  # ===================
  # Frontend (Nginx)
  # ===================
  app:
    build:
      context: ../..
      dockerfile: deploy/multitenant/Dockerfile.app
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_SITE_NAME: ${SITE_NAME:-GameTaverns}
    container_name: gametaverns-app
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_URL: http://api:3001
    ports:
      - "${APP_PORT:-80}:80"
    networks:
      - gametaverns

  # ===================
  # Nginx Reverse Proxy
  # ===================
  # Handles SSL termination and subdomain routing
  proxy:
    image: nginx:alpine
    container_name: gametaverns-proxy
    restart: unless-stopped
    depends_on:
      - app
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/proxy.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot_webroot:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro
    networks:
      - gametaverns
    profiles:
      - production

  # ===================
  # Certbot (SSL)
  # ===================
  certbot:
    image: certbot/certbot
    container_name: gametaverns-certbot
    volumes:
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - gametaverns
    profiles:
      - production

networks:
  gametaverns:
    driver: bridge

volumes:
  db_data:
  uploads:
  certbot_webroot:
  certbot_certs:
